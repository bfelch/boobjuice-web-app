CREATE TABLE IF NOT EXISTS `PUMPED_MILK` (
  `U_PUMPED` timestamp NOT NULL,
  `Q_PUMPED_GRAMS` smallint(5) unsigned DEFAULT NULL,
  `Q_PUMPED_MINUTES` smallint(5) unsigned DEFAULT NULL,
  `U_PROFILE` smallint(6) DEFAULT NULL,
  `S_UPDATE` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`U_PUMPED`),
  UNIQUE KEY `U_PUMPED_U1` (`U_PUMPED`),
  KEY `U_PROFILE` (`U_PROFILE`),
  CONSTRAINT `PUMPED_MILK_ibfk_1` FOREIGN KEY (`U_PROFILE`) REFERENCES `PUMP_PROFILE` (`U_PROFILE`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

DELIMITER $$

DROP PROCEDURE IF EXISTS UPGRADE_DB_1_0_TO_1_1 $$
CREATE PROCEDURE UPGRADE_DB_1_0_TO_1_1()
BEGIN
IF NOT EXISTS(
	(SELECT *
	   FROM information_schema.COLUMNS
	  WHERE TABLE_SCHEMA = DATABASE()
	    AND COLUMN_NAME = 'U_PROFILE'
		AND TABLE_NAME = 'PUMPED_MILK')
) THEN
    ALTER TABLE `PUMPED_MILK`
    ADD COLUMN IF NOT EXISTS `U_PROFILE` smallint(6) NULL AFTER `Q_PUMPED_MINUTES`,
    CHANGE `S_UPDATE` `S_UPDATE` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE CURRENT_TIMESTAMP AFTER `U_PROFILE`,
    ADD FOREIGN KEY IF NOT EXISTS (`U_PROFILE`) REFERENCES `PUMP_PROFILE` (`U_PROFILE`) ON DELETE SET NULL;
END IF;
END $$
CALL UPGRADE_DB_1_0_TO_1_1() $$

DELIMITER ;